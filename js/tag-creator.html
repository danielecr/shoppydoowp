<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&load[]=jquery-core,jquery-migrate,utils,plupload&ver=4.3.1'></script>    
    <script>

    var args = top.tinymce.activeEditor.windowManager.getParams();
var $ = args.jQuery;

var tcre;

jQuery(function() {
    tcre = new TagCreator(jQuery);
    console.log('init ... tagcreator');

    tcre.init("#s-tag-creator");
    //console.log('realsize', jQuery("#sdwp-insert-btn").size());
    
});

var hierarchicalDropDown = function(jQuery) {
    this.$ = jQuery;
};

hierarchicalDropDown.prototype = {
    aSource: [],
    init: function (aSource) {
	this.aSource = aSource;
	//this.onSelect(-1);
    },
    fillWithParent: function(parent) {
	var exList = this.exclusionList;
	this.selection = this.aSource.filter(function(e){ return parseInt(e.parent)==parseInt(parent);});
	this.selectionWithExclusion = this.selection.filter(function(e) {return (exList.indexOf(parseInt(e.code)) === -1); });
	this.current = this.aSource.filter(function(e){ return parseInt(e.code)==parseInt(parent);});
	this.current = this.current[0];
    },
    onSelect: function(code) {
	this.fillWithParent(code);
	this.setExclusion(code);
	this.cbSelection(this.current);
	this.cbOptions(this.selectionWithExclusion);
    },
    setupCB: function(cbSelection, cbOptions) {
	this.cbSelection = cbSelection;
	this.cbOptions = cbOptions;
    },
    exclusionList: [],
    selectionWithExclusion: [],
    setExclusion: function (code) {	
	this.exclusionList.push(parseInt(code));
    },

};
// use it as:
//var h_dd = new hierarchicalDropDown()
//h_dd.init(aSource);
//h_dd.setupCB(function(sel) {fillSelection(sel);},function(opts) {fillOptions(opts);});

var TagCreator = function(jQuery) {
    this.jQuery = jQuery;
};
TagCreator.prototype = {
    targetAjax: '',
    init: function(id) {
	var self = this;
	jQuery = self.jQuery;
	self.id = id;
	
	self.containerQ = jQuery(id);
	//self.addactions();
	self.targetAjax = $("#sdwp-target-ajax").val();
	console.log (  self.targetAjax) ;
	jQuery("#sdwp-insert-btn").on('click',function(e) {
	    var theTag = this.synthetizeTag();
	    top.tinymce.activeEditor.insertContent(theTag + 'Title: ' + e.target);

	    top.tinymce.activeEditor.windowManager.close();
	    console.log('esso mi vede');
	});
	//top.tinymce.activeEditor.windowManager.close();
	console.log('size of it', jQuery("#sdwp-insert-btn").size());
	this.getCategoryList();
    },
    sinthetizeTag: function() {
	return "[[]]";
    },
    addactions: function(){
	var self = this;
	//jQuery(".add-category",self.containerQ).on('click',self.addCategory.bind(self))
    },
    availCategories: [],
    categoryList: [],
    addCategory: function(e) {
	var self = this
	var value = $(".category", self.containerQ).val();
	self.categoryList.push(parseInt(value));
	self.fillCategories();
	console.log(self.categoryList);
	e.preventDefault();
	return false;
    },
    fillCategories: function(){
	var self = this;
	var theSelect = jQuery(".category", self.containerQ)
	theSelect.html('');
	$.each(self.availCategories,function(i,el){
	    console.log('index of ',i, el, self.categoryList.indexOf(i),self.categoryList);
	    if(self.categoryList.indexOf(parseInt(el.value)) === -1 ) {
		theSelect.append($("<option>").html(el.text).val(el.value));
	    }
	})
    },
    currentPath: [],
    currentCat: undefined,
    fillSelection: function(sel){
	console.log('currentSel',sel);
	if(sel.code == -1) {
	    this.currentPath = [sel];
	} else {
	    var idxOf = this.currentPath.indexOf(sel);
	    console.log('index of',idxOf);
	    if(idxOf >=0) {
		while(this.currentPath.length -1 > idxOf) {
		    this.currentPath.pop();
		}
	    } else {
		this.currentPath.push(sel);
	    }
	}
	console.log( 'current PATH: ',this.currentPath);
	this.currentCat = sel;
    },
    selectOne: function(e) {
	var val = jQuery(e.target).val();
	if(val == -10) {
	    console.log(-10);
	    return;
	}
	if(val == -1) {
	    console.log(-1);
	}
	this.h_dd.onSelect(val);
	this.selectedCode = parseInt(val);
    },
    selectedCode: -1,
    fillOptions: function(opts) {
	var self = this;
	var theSelect = jQuery(".category", self.containerQ)
	theSelect.html('');
	theSelect.off('change');
	theSelect.on('change',self.selectOne.bind(self));
	theSelect.append(jQuery("<option>").html('-').val(-10));
	if(self.selectedCode != -1) {
	    theSelect.append(jQuery("<option>").html('^ Tutte le categorie').val(-1));
	}
	if(self.currentCat != undefined && parseInt(self.currentCat.code) != -1 ) {
	    theSelect.append(jQuery("<option>").html('^ '+self.currentCat.catname).val(self.currentCat.parent));
	}
	$.each(opts,function(i,el){
	    //console.log('index of ',i, el, self.categoryList.indexOf(i),self.categoryList);
	    theSelect.append(jQuery("<option>").html(el.catname).val(el.code));
	})
    },
    fillAvailCategories: function (data) {
	var self = this;
	var h_dd = new hierarchicalDropDown();
	this.h_dd = h_dd;
	h_dd.init(data);
	h_dd.setupCB(function(sel) {self.fillSelection(sel);},function(opts) {self.fillOptions(opts);});
	console.log(data);
	h_dd.onSelect(-1);
	return;
    },
    getCategoryList: function() {
	var self = this
	var data = {
	    'action': 'shoppydoo_product_categories_action',
	    'tipo': 'val' // ajax_object.we_value      // We pass php values differently!
	};
	//$(this).parents('div.mol-outer-form').html('');
	var admin_ajax_url = self.targetAjax;
	$.ajax({url:admin_ajax_url, data:data,method:'post',success: self.fillAvailCategories.bind(self)});

    }
}



</script>

<div id="s-tag-creator">
  <h4>Crea tag shoppydoo</h4>
  <div>
  Aggiungi categoria: 
  <select class="category">
    <option>c</option>
  </select>
  <button class="add-category">Aggiungi</button>
  </div>
  <div>
  
  </div>
  
  <div>Tag risultante: 
      <input id="shoppy-the-tag" class="resulting-tag" name="the_tag" readonly="readonly" />

  </div>
  <div>
	  <button id="sdwp-insert-btn">Inserisci</button>
  </div>
  
  </div>
